#!/usr/bin/env ruby

# A few helpful tips about the Rules file:
#
# * The order of rules is important: for each item, only the first matching
#	 rule is applied.
#
# * Item identifiers start and end with a slash (e.g. “/about/” for the file
#	 “content/about.html”). To select all children, grandchildren, … of an
#	 item, use the pattern “/about/*/”; “/about/*” will also select the parent,
#	 because “*” matches zero or more characters.

compile '/' do
	filter :erb
	filter :redcloth, :hard_breaks => false
	filter :colorize_syntax,
	       :colorizers => { :objc => :pygmentize, 
	                        :python => :pygmentize,
	                        :sh => :pygmentize
	                      }
	layout 'default'
end

compile '/about/' do
	filter :kramdown
	layout 'default'
end

compile '/posts/' do
	filter :erb
	layout 'default'
end

compile '/posts/*/' do
	@item[:kind] = :article
	layout 'post'
	filter :redcloth, :hard_breaks => false
	filter :colorize_syntax,
	       :colorizers => { :objc => :pygmentize,
	                        :python => :pygmentize,
	                        :sh => :pygmentize
	                      }
	layout 'default'
end

compile '/posts/*/', :rep => :alt_url do
	@item[:source_url] = @item.identifier.chop + '/index.html'
	layout 'redirect'
end

compile '/css/*/' do
	# compress CSS :)
	filter :rainpress
end

compile '/images/*/' do
	# don't compile
end

compile '/i/*/' do
	# make images fit the blog's size
	filter :thumbnailize, :width => 520
	#if item[:extension] == "png"
	#	filter :pngcrush, :level => 7
	#end
end

compile '/fonts/*/' do
	# don't compile
end

compile '*' do
	filter :erb
	layout 'default'
end

route '/css/*/' do
	@item.identifier.chop + '.' + @item[:extension]
end

route '/images/*/' do
	@item.identifier.chop + '.' + @item[:extension]
end

route '/i/*/' do
	@item.identifier.chop + '.' + @item[:extension]
end

route '/fonts/*/' do
	@item.identifier.chop + '.' + @item[:extension]
end

route '/posts/*/' do
	parts = @item.name.split('-', 4)
	if @item[:created_at]
		'/posts/' + @item[:created_at].year().to_s + '/' + parts[3] + '/index.html'
	else
		puts "Skipping " + @item.name
	end
end

route '*', :rep => :alt_url do
	@item[:alt_url]
end

route '*' do
	@item.identifier + 'index.html'
end

layout '*', :erb
